!function(e){"use strict";var t=function(e,t,i){this.width=e,this.height=t,this.root=new THREE.Object3D,this.root.matrixAutoUpdate=!1,this.config=i,this.listeners={},this.version="0.3.0",console.log("ARnft ",this.version)};t.prototype.init=function(a,o){console.log("ARnft init() %cstart...","color: yellow; background-color: blue; border-radius: 4px; padding: 2px");this.cameraPara;var r=this.root;(async function(e,t){return await new Promise((function(t,i){const n=new XMLHttpRequest;n.open("GET",e),n.responseType="json",n.onload=function(){t(n.response)},n.onerror=function(){i("error "+n.status)},n.send(null)}))})(this.config).then((function(s){!function(e){var t=document.createElement("div");t.id="loading";var i=document.createElement("img");i.src=e.loading.logo.src,i.alt=e.loading.logo.alt;var n=document.createElement("span");n.setAttribute("class","loading-text"),n.innerText=e.loading.loadingMessage,t.appendChild(i),t.appendChild(n);document.getElementById("marker");document.body.insertBefore(t,document.body.firstChild)}(s),function(e){if(e){var t=document.createElement("div");t.id="stats",t.className="ui stats";var i=document.createElement("div");i.id="stats1",i.className="stats-item";var n=document.createElement("p");n.className="stats-item-title",n.innerText="Main",i.appendChild(n),t.appendChild(i);var a=document.createElement("div");a.id="stats2",a.className="stats-item";var o=document.createElement("p");o.className="stats-item-title",o.innerText="Worker",a.appendChild(o),t.appendChild(a);var r=document.getElementById("loading");document.body.insertBefore(t,r)}}(o);var d,c,l=function(){var e=document.createElement("div");e.id="app";var t=document.createElement("canvas");t.id="canvas";var i=document.createElement("video");i.id="video",i.setAttribute("autoplay",""),i.setAttribute("muted",""),i.setAttribute("playsinline",""),e.appendChild(i),e.appendChild(t);var n=document.getElementById("loading");return document.body.insertBefore(e,n),{container:e,canvas:t,video:i}}(),v=(l.container,l.canvas),m=l.video;o&&((d=new Stats).showPanel(0),document.getElementById("stats1").appendChild(d.dom),(c=new Stats).showPanel(0),document.getElementById("stats2").appendChild(c.dom)),function(a,o,r,s,d,c,l){var v=l.videoSettings.facingMode||"environment",m=l.onError||function(e){console.error("ARnft internal getUserMedia",e)},u=!1,g=["touchstart","touchend","touchmove","touchcancel","click","mousedown","mouseup","mousemove","keydown","keyup","keypress","scroll"],h=function(){u&&(r.play().then((function(){!function(t,a,o,r,s,d,c,l,v,m){var u,g,h,p,f,E,y,w,x,b,M,S,k,U=document.createElement("canvas"),R=U.getContext("2d"),T=new THREE.WebGLRenderer({canvas:d,alpha:m.renderer.alpha,antialias:m.renderer.antialias,precision:m.renderer.precision});T.setPixelRatio(e.devicePixelRatio);var A=new THREE.Scene,H=new THREE.Camera;H.matrixAutoUpdate=!1,A.add(H);var C=new THREE.AmbientLight(16777215);A.add(C),A.add(v);var I,L=function(e){I=e?JSON.parse(e.matrixGL_RH):null},j=Date.now();function W(){R.fillStyle="black",R.fillRect(0,0,x,b),R.drawImage(o,0,0,u,g,M,S,y,w);var e=R.getImageData(0,0,x,b);k.postMessage({type:"process",imagedata:e},[e.data.buffer])}var P=function(){B(),requestAnimationFrame(P)},B=function(){c();var e=Date.now();if(e-j,j=e,I){v.visible=!0;for(var t=0;t<16;t++)i.delta[t]=I[t]-i.interpolated[t],i.interpolated[t]=i.interpolated[t]+i.delta[t]/24;n(v.matrix,i.interpolated)}else v.visible=!1;T.render(A,H)};u=r,g=s,f=320/Math.max(u,g/3*4),E=/Android|mobile|iPad|iPhone/i.test(navigator.userAgent)?e.outerWidth/r:1,h=u*E,p=g*E,y=u*f,w=g*f,x=Math.max(y,w/3*4),b=Math.max(w,y/4*3),M=(x-y)/2,S=(b-w)/2,U.style.clientWidth=x+"px",U.style.clientHeight=b+"px",U.width=x,U.height=b,T.setSize(h,p),(k=new Worker(m.workerUrl)).postMessage({type:"load",pw:x,ph:b,camera_para:m.cameraPara,marker:a,artoolkitUrl:m.artoolkitUrl}),k.onmessage=function(e){var t=e.data;switch(t.type){case"loaded":var i=JSON.parse(t.proj),a=x/y,o=b/w;i[0]*=a,i[4]*=a,i[8]*=a,i[12]*=a,i[1]*=o,i[5]*=o,i[9]*=o,i[13]*=o,n(H.projectionMatrix,i);break;case"endLoading":if(1==t.end){var r=document.getElementById("loading");r&&(r.querySelector(".loading-text").innerText="Start the tracking!",setTimeout((function(){r.parentElement.removeChild(r)}),2e3))}break;case"found":L(t);break;case"not found":L(null)}l(),W()},P(),W()}(0,o,r,r.videoWidth,r.videoHeight,s,(function(){c.stats&&c.statsMain.update()}),(function(){c.stats&&c.statsWorker.update()}),d,l)})).catch((function(e){m(e),t._teardownVideo(r)})),r.paused||g.forEach((function(t){e.removeEventListener(t,h,!0)})))};g.forEach((function(t){e.addEventListener(t,h,!0)}));var p=function(t){if(e.URL.createObjectURL)try{r.srcObject=t}catch(e){}r.srcObject=t,u=!0,r.autoplay=!0,r.playsInline=!0,h()},f={},E={};l.videoSettings.width&&(E.width=l.videoSettings.width,"object"==typeof l.videoSettings.width?(l.videoSettings.width.max&&(f.maxWidth=l.videoSettings.width.max),l.videoSettings.width.min&&(f.minWidth=l.videoSettings.width.min)):f.maxWidth=l.videoSettings.width);l.videoSettings.height&&(E.height=l.videoSettings.height,"object"==typeof l.videoSettings.height?(l.videoSettings.height.max&&(f.maxHeight=l.videoSettings.height.max),l.videoSettings.height.min&&(f.minHeight=l.videoSettings.height.min)):f.maxHeight=l.videoSettings.height);E.facingMode=v,E.deviceId=l.videoSettings.deviceId,navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;var y={audio:!1,video:f};navigator.mediaDevices||e.MediaStreamTrack.getSources?navigator.mediaDevices?navigator.mediaDevices.getUserMedia({audio:!1,video:E}).then(p,m):e.MediaStreamTrack.getSources((function(e){var t=E.facingMode;v&&v.exact&&(t=v.exact);for(var i=0;i<e.length;i++)if("video"===e[i].kind&&e[i].facing===t){y.video.mandatory.sourceId=e[i].id;break}v&&v.exact&&!y.video.mandatory.sourceId?m("Failed to get camera facing the wanted direction"):navigator.getUserMedia?navigator.getUserMedia(y,p,m):m("navigator.getUserMedia is not supported on your browser")})):navigator.getUserMedia?navigator.getUserMedia(y,p,m):m("navigator.getUserMedia is not supported on your browser")}(0,a,m,v,r,{statsMain:d,statsWorker:c,stats:o},s)}))},t.prototype.add=function(e){this.root.add(e)},t.prototype.loadModel=function(e,t,i,n,a){var o,r=this.root;(new THREE.GLTFLoader).load(e,(function(e){(o=e.scene).scale.set(a,a,a),o.rotation.x=Math.PI/2,o.position.x=t,o.position.y=i,o.position.z=n,o.matrixAutoUpdate=!1,r.add(o)}))},t.prototype.dispatchEvent=function(e){if(e=this.listeners[event.name])for(var t=0;t<e.length;t++)e[t].call(this,event)},t.prototype.addEventListener=function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)},t.prototype.removeEventListener=function(e,t){if(this.listeners[e]){var i=this.listeners[e].indexOf(t);i>-1&&this.listeners[e].splice(i,1)}},t._teardownVideo=function(e){e.srcObject.getVideoTracks()[0].stop(),e.srcObject=null,e.src=null};var i={delta:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],interpolated:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},n=function(e,t){var i=[];for(var n in t)i[n]=t[n];"function"==typeof e.elements.set?e.elements.set(i):e.elements=[].slice.call(i)};e.ARnft=t,e.THREE=THREE}(window);